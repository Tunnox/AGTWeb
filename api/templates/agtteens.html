<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AGT Teens Records</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-image: url('https://raw.githubusercontent.com/Tunnox/Images/main/AgtTeens_1.jpg');
      background-size: cover;
      background-position: center;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      backdrop-filter: blur(4px);
    }

    .glass-card, .section-card {
      background: rgba(0, 0, 0, 0.5);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-top: 30px;
    }

    .form-control, .form-select {
      background-color: rgba(255, 255, 255, 0.1);
      border: none;
      color: #fff;
    }

    .form-control::placeholder {
      color: #ddd;
    }

    .form-control:focus, .form-select:focus {
      background-color: rgba(10, 12, 17, 0.986);
      color: #fff;
    }

    .form-select {
      background-color: rgba(10, 12, 17, 0.986);
    }

    .search-result-item {
      background-color: rgba(255, 255, 255, 0.8);
      color: #000;
      padding: 10px;
      margin-bottom: 5px;
      border-radius: 5px;
      cursor: pointer;
    }

    .search-result-item:hover {
      background-color: rgba(255, 255, 255, 1);
    }

    .btn {
      border-radius: 10px;
    }

    h1, h2, h3, h4, h5 {
      text-shadow: 1px 1px 2px #000;
    }

    .modal-content {
      background: rgba(25, 30, 58, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 16px;
    }

    label {
      margin-top: 8px;
    }

    .navbar {
      background-color: #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 15px 20px;
      position: sticky;
      top: 0;
      z-index: 999;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .nav-brand {
      font-size: 20px;
      font-weight: bold;
      color: #04395E;
    }

    .nav-toggle {
      display: none;
      font-size: 24px;
      cursor: pointer;
      background: none;
      border: none;
      color: #04395E;
    }

    .nav-links {
      display: flex;
      gap: 12px;
    }

    .nav-links a {
      text-decoration: none;
      color: #04395E;
      padding: 8px 14px;
      border-radius: 6px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .nav-links a:hover {
      background-color: #20c997;
      color: white;
      transform: scale(1.05);
    }

    @media (max-width: 768px) {
      .nav-links {
        flex-direction: column;
        background-color: #fff;
        position: absolute;
        top: 60px;
        right: 20px;
        width: 200px;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: none;
      }

      .nav-links.open {
        display: flex;
      }

      .nav-toggle {
        display: block;
      }
    }

    .section-title {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 20px;
      color: #fff;
      text-shadow: 1px 1px 3px #000;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      padding-bottom: 10px;
    }
  </style>
</head>
<body class="bg-dark text-light">
  <div class="container py-4">
    <h2 class="text-center mb-4">AGT Teens Record Management</h2>

    <!-- Create Record -->
    <div class="mb-4">
      <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createModal">Create New Record</button>
    </div>

    <!-- Search -->
    <div class="mb-4">
      <h4>Search Teens</h4>
      <input type="text" id="searchInput" class="form-control" placeholder="Search by name, age, gender...">
      <div id="searchResults" class="mt-2"></div>
    </div>

    <!-- Attendance -->
    <div class="mb-4">
      <h4>Record Attendance</h4>
      <input type="text" id="attendanceSearchInput" class="form-control mb-2" placeholder="Search by name...">
      <div id="attendanceSearchResults" class="mt-2"></div>
      <div id="selectedRecord" class="border p-3 d-none">
        <h5 id="selectedName"></h5>
        <p id="selectedContact"></p>
        <input type="checkbox" id="markPresent"> <label for="markPresent">Mark as Present</label>
        <p id="attendanceAlreadyMarked" class="text-warning mt-2"></p>
        <button class="btn btn-primary mt-2" id="submitAttendance">Take Attendance</button>
      </div>
    </div>

    <!-- Roll Call -->
    <div class="mb-4">
      <h4>Roll Call Attendance</h4>
      <div class="border p-3">
        <h5 id="rollCallName">Loading...</h5>
        <input type="checkbox" id="rollCallPresent"> <label for="rollCallPresent">Mark Present</label>
        <p id="rollCallAlreadyMarked" class="text-warning mt-2"></p>
        <button class="btn btn-primary mt-2" id="nextRollCall">Next Name</button>
      </div>
    </div>

    <!-- Download Attendance -->
    <div class="mb-4">
      <h4>Download Attendance</h4>
      <select id="dateDropdown" class="form-select mb-2"></select>
      <button class="btn btn-info" id="downloadCsvBtn">Download CSV</button>
    </div>
  </div>

  <!-- Create Modal -->
  <div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content p-4">
        <h4>Create New Teen Record</h4>
        <form method="POST" action="/teens_church/insert">
          <input name="first_name" class="form-control" placeholder="First Name" required>
          <input name="last_name" class="form-control" placeholder="Last Name" required>
          <input name="age" type="number" class="form-control" placeholder="Age" required>
          <select name="gender" class="form-select" required>
            <option value="">Select Gender</option>
            <option>Male</option>
            <option>Female</option>
            <option>Other</option>
          </select>
          <input name="birthday" class="form-control" placeholder="Birthday" required>
          <input name="contact_number" class="form-control" placeholder="Contact Number" required>
          <select name="age_group" class="form-select" required>
            <option>Teenager</option>
            <option>YAYA</option>
            <option>Adult</option>
          </select>
          <input name="department" class="form-control" placeholder="Department" required>
          <select name="relationship_status" class="form-select" required>
            <option>Single</option>
            <option>Not single</option>
          </select>
          <input name="email" class="form-control" placeholder="Email" required>
          <input name="address" class="form-control" placeholder="Address" required>
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" name="consent" value="Yes" required>
            <label class="form-check-label">Consent to UK GDPR</label>
          </div>
          <button class="btn btn-success mt-3" type="submit">Save</button>
        </form>
      </div>
    </div>
  </div>

<script>
function checkIfAlreadyPresent(name) {
  return fetch('/teens_check_attendance', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name })
  }).then(res => res.json());
}

// --------- ROLL CALL ---------
let rollCallList = [], rollCallIndex = 0;
function loadRollCallList() {
  fetch('/teens_roll_call_names')
    .then(res => res.json())
    .then(data => {
      rollCallList = data;
      rollCallIndex = 0;
      showRollCallName();
    });
}
function showRollCallName() {
  const current = rollCallList[rollCallIndex];
  const nameEl = document.getElementById('rollCallName');
  const checkEl = document.getElementById('rollCallPresent');
  const noteEl = document.getElementById('rollCallAlreadyMarked');

  if (!current) {
    nameEl.innerText = 'ðŸŽ‰ Roll call complete!';
    checkEl.disabled = true;
    return;
  }
  nameEl.innerText = current.name;
  checkEl.checked = false;
  checkEl.disabled = false;
  noteEl.innerText = '';
  checkIfAlreadyPresent(current.name).then(result => {
    if (result.present) {
      checkEl.checked = true;
      checkEl.disabled = true;
      noteEl.innerText = `âœ… Already marked present on ${result.date}`;
    }
  });
}
document.getElementById('nextRollCall').onclick = () => {
  if (!document.getElementById('rollCallPresent').disabled && document.getElementById('rollCallPresent').checked) {
    const teen = rollCallList[rollCallIndex];
    fetch('/teens_record_attendance', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: teen.name, contact: teen.contact })
    });
  }
  rollCallIndex++;
  showRollCallName();
};

// --------- ATTENDANCE SEARCH ---------
document.getElementById('attendanceSearchInput').addEventListener('input', function () {
  const keyword = this.value;
  if (keyword.length < 2) return;
  fetch('/teens_church/search', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: new URLSearchParams({ keyword })
  })
  .then(res => res.json())
  .then(data => {
    const output = document.getElementById('attendanceSearchResults');
    output.innerHTML = '';
    data.forEach(record => {
      const div = document.createElement('div');
      div.innerText = `${record.first_name} ${record.last_name}`;
      div.classList.add('border', 'p-2', 'mb-1');
      div.onclick = () => {
        document.getElementById('selectedName').innerText = `${record.first_name} ${record.last_name}`;
        document.getElementById('selectedContact').innerText = `Contact: ${record.contact_number}`;
        document.getElementById('selectedRecord').classList.remove('d-none');
        checkIfAlreadyPresent(`${record.first_name} ${record.last_name}`).then(result => {
          const cb = document.getElementById('markPresent');
          const msg = document.getElementById('attendanceAlreadyMarked');
          cb.checked = false; cb.disabled = false; msg.innerText = '';
          if (result.present) {
            cb.checked = true;
            cb.disabled = true;
            msg.innerText = `âœ… Already marked present on ${result.date}`;
          }
        });
      };
      output.appendChild(div);
    });
  });
});

document.getElementById('submitAttendance').onclick = function () {
  const cb = document.getElementById('markPresent');
  if (!cb.checked || cb.disabled) return;
  const name = document.getElementById('selectedName').innerText;
  const contact = document.getElementById('selectedContact').innerText.split(': ')[1];
  fetch('/teens_record_attendance', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, contact })
  })
  .then(res => res.json())
  .then(data => alert(data.message || data.error));
};

// --------- SEARCH TEENS ---------
document.getElementById('searchInput').addEventListener('input', function () {
  const keyword = this.value;
  if (keyword.length < 2) return;
  fetch('/teens_church/search', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: new URLSearchParams({ keyword })
  })
  .then(res => res.json())
  .then(data => {
    const output = document.getElementById('searchResults');
    output.innerHTML = '';
    data.forEach(record => {
      const div = document.createElement('div');
      div.className = 'border p-2 mb-1';
      div.innerText = `${record.first_name} ${record.last_name}`;
      output.appendChild(div);
    });
  });
});

// --------- DOWNLOAD CSV ---------
document.addEventListener('DOMContentLoaded', () => {
  fetch('/teens_get_dates')
    .then(res => res.json())
    .then(data => {
      const dropdown = document.getElementById('dateDropdown');
      data.forEach(date => {
        const opt = document.createElement('option');
        opt.value = date; opt.textContent = date;
        dropdown.appendChild(opt);
      });
    });

  document.getElementById('downloadCsvBtn').onclick = () => {
    const date = document.getElementById('dateDropdown').value;
    fetch(`/teens_download_attendance_csv?date=${date}`)
      .then(res => res.blob())
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `AGT_Attendance_${date}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      });
  };

  loadRollCallList();
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
