<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>User Profile | AGT</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary: #20c997;
      --primary-600: #198754;
      --accent: #0dcaf0;
      --bg-light: #f6f7fb;
      --bg-dark: #0f1116;
      --card-light: #ffffff;
      --card-dark: #15151b;
      --muted: #6b7280;
      --glass: rgba(255,255,255,0.7);
      --radius: 16px;
      --shadow-lg: 0 12px 30px rgba(2,6,23,0.12);
      --max-width: 720px;
    }

    [data-theme="light"]{
      --bg: var(--bg-light);
      --card: var(--card-light);
      --text: #0b1220;
      --glass: rgba(255,255,255,0.85);
    }
    [data-theme="dark"]{
      --bg: linear-gradient(180deg,#07060a,#0b0b12);
      --card: var(--card-dark);
      --text: #e6eef8;
      --muted: #9aa0b4;
      --glass: rgba(20,20,28,0.6);
    }

    /* Global */
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:env(safe-area-inset-top) 12px 90px env(safe-area-inset-left);
      box-sizing:border-box;
      min-height:100vh;
    }

    /* Container */
    .container{
      width:100%;
      max-width:var(--max-width);
      margin:16px 0;
    }

    /* Top bar */
    .topbar{
      position:sticky;
      top:8px;
      z-index:1200;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 14px;
      border-radius:14px;
      background:var(--glass);
      box-shadow:var(--shadow-lg);
      backdrop-filter: blur(8px);
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .logo{
      width:44px;height:44px;border-radius:12px;
      background:linear-gradient(135deg,var(--primary),var(--accent));
      display:flex;align-items:center;justify-content:center;color:white;font-weight:700;
      box-shadow:0 6px 18px rgba(32,201,151,0.18);
      font-size:18px;
    }
    .brand h1{margin:0;font-size:16px;letter-spacing:-0.2px}
    .brand p{margin:0;font-size:12px;color:var(--muted)}

    .top-actions{display:flex;gap:8px;align-items:center}
    .theme-toggle{
      border:0;padding:8px 12px;border-radius:10px;background:transparent;cursor:pointer;font-weight:600;
      display:inline-flex;gap:8px;align-items:center;color:var(--text)
    }

    /* Profile card */
    .card{
      margin-top:12px;
      background:var(--card);
      border-radius:20px;
      box-shadow:var(--shadow-lg);
      padding:18px;
      overflow:hidden;
    }

    .profile-head{
      display:flex;
      gap:14px;
      align-items:center;
    }
    .avatar{
      min-width:84px;min-height:84px;width:84px;height:84px;border-radius:18px;
      display:flex;align-items:center;justify-content:center;font-weight:700;
      font-size:26px;color:white;background:linear-gradient(135deg,var(--primary),var(--primary-600));
      box-shadow:0 8px 20px rgba(32,201,151,0.14);
    }
    .profile-meta{flex:1}
    .profile-meta h2{margin:0;font-size:18px}
    .profile-meta small{display:block;color:var(--muted);margin-top:6px;font-size:13px}

    /* Info grid */
    .info-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:14px;
    }
    .info-item{
      background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent);
      border-radius:12px;padding:12px;font-size:13px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.03);
    }
    .info-item strong{display:block;color:var(--primary);margin-bottom:6px}

    /* Section title */
    .section-title{
      margin-top:16px;
      display:flex;justify-content:space-between;align-items:center;
      gap:8px;
    }
    .section-title h3{margin:0;font-size:15px}
    .section-title .muted{font-size:13px;color:var(--muted)}

    /* Buttons */
    .btn{
      display:inline-flex;align-items:center;gap:8px;border:0;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;
    }
    .btn-primary{background:linear-gradient(90deg,var(--primary),var(--accent));color:white;box-shadow:0 8px 22px rgba(32,201,151,0.12)}
    .btn-ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--text)}
    .btn-danger{background:crimson;color:white}

    /* Collapsible content */
    .collapsible{
      margin-top:10px;border-radius:12px;padding:12px;background:var(--bg);box-shadow:inset 0 1px 0 rgba(0,0,0,0.03);
      display:none;
    }

    /* Delete section */
    .delete-section{
      margin-top:14px;padding:14px;border-radius:12px;background:var(--card);box-shadow:0 6px 18px rgba(0,0,0,0.06);
    }
    .delete-section select{width:100%;padding:12px;border-radius:10px;border:1px solid #e6e9ef;margin-top:8px}
    .delete-section .delete-actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .warning{color:crimson;font-weight:700;font-size:13px;margin-top:8px}

    /* Rota calendar grid (mobile friendly) */
    .calendar-controls{display:flex;gap:8px;margin-bottom:10px}
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .calendar-cell{padding:8px;border-radius:10px;font-size:12px;min-height:44px;display:flex;flex-direction:column;align-items:center;justify-content:center;border:1px dashed rgba(0,0,0,0.03)}
    .calendar-cell input{margin-top:6px}

    /* Floating action - edit */
    .fab{
      position:fixed;right:16px;bottom:18px;z-index:1400;
      width:64px;height:64px;border-radius:999px;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,var(--primary),var(--accent));color:white;font-weight:800;border:0;
      box-shadow:0 18px 36px rgba(32,201,151,0.14);cursor:pointer;
    }

    /* Bottom navigation (mobile) */
    .bottom-nav{
      position:fixed;left:0;right:0;bottom:0;height:62px;padding:8px 12px;display:flex;justify-content:space-between;align-items:center;
      gap:10px;background:var(--glass);backdrop-filter:blur(8px);z-index:1200;border-top-left-radius:14px;border-top-right-radius:14px;
    }
    .nav-btn{flex:1;text-align:center;padding:8px;border-radius:10px;font-weight:700;cursor:pointer;border:0;background:transparent;color:var(--text)}

    /* Modal */
    .modal{
      display:none;
      position:fixed;inset:0;align-items:flex-end;justify-content:center;padding:12px;z-index:2000;
    }
    .modal.backdrop{background:linear-gradient(0deg, rgba(0,0,0,0.45), rgba(0,0,0,0.45));display:flex;}
    .sheet{
      width:100%;max-width:720px;border-radius:18px;background:var(--card);padding:16px;box-shadow:0 12px 36px rgba(2,6,23,0.28);
      transform:translateY(0);
    }
    .modal .sheet .sheet-header{display:flex;justify-content:space-between;align-items:center}
    .form-group{margin-top:12px;display:flex;flex-direction:column}
    .form-group label{font-weight:700;margin-bottom:6px}
    .form-group input,.form-group textarea,.form-group select{
      padding:12px;border-radius:10px;border:1px solid #e9eef6;font-size:14px
    }
    .modal-close{background:transparent;border:0;font-size:20px;cursor:pointer}

    /* small screens adjustments */
    @media (max-width:420px){
      .avatar{width:72px;height:72px;border-radius:14px}
      .info-grid{grid-template-columns:1fr}
      .topbar{padding:10px}
      .fab{width:60px;height:60px}
      .container{padding-bottom:84px}
      .sheet{border-radius:16px}
    }

    /* Animations */
    .fade-in{animation:fadeIn .35s ease both}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>
  <div class="container">
    <header class="topbar fade-in" role="banner" aria-label="Top Bar">
      <div class="brand" aria-hidden="false">
        <div class="logo" id="mini-logo">AG</div>
        <div>
          <h1>AGT Sheffield</h1>
          <p>Mobile profile</p>
        </div>
      </div>

      <div class="top-actions">
        <button class="theme-toggle" onclick="toggleTheme()" aria-pressed="false" title="Toggle theme">üåó Theme</button>
      </div>
    </header>

    <main class="card fade-in" role="main" aria-labelledby="profile-title">
      <div class="profile-head">
        <div class="avatar" id="profile-avatar">üë§</div>
        <div class="profile-meta">
          <h2 id="full-name">Loading‚Ä¶</h2>
          <small id="profile-sub">Profile details</small>
        </div>

        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn btn-primary" onclick="openEditSelector()" aria-label="Edit">Edit ‚úé</button>
          <button class="btn btn-ghost" onclick="window.location.href='/my_profile'">‚Üê Back</button>
        </div>
      </div>

      <div class="info-grid" id="contact-info-grid" style="margin-top:14px;">
        <!-- Info items injected here -->
      </div>

      <div class="section-title">
        <h3>Other Details</h3>
        <span class="muted">Tap a row to expand</span>
      </div>

      <div id="other-details" class="collapsible" style="display:block;padding:0;margin-top:8px;background:transparent;box-shadow:none"></div>

      <div id="worker-section" style="margin-top:14px"></div>

      <div id="rota-section" style="margin-top:14px"></div>

      <div class="delete-section" aria-labelledby="delete-title">
        <h3 id="delete-title">üóë Delete Your Record</h3>
        <p class="muted" style="margin:6px 0 0 0">Select where to delete your record from:</p>
        <select id="delete-option" aria-label="Delete option" >
          <option value="">-- Select Database --</option>
          <option value="agt">AGT database</option>
          <option value="workers">AGT Workers database</option>
        </select>
        <div class="delete-actions">
          <button class="btn btn-danger" onclick="handleDelete()">Delete</button>
          <button class="btn btn-ghost" onclick="document.getElementById('delete-warning').innerHTML = ''">Cancel</button>
        </div>
        <div id="delete-warning" class="warning" role="status" aria-live="polite"></div>
      </div>

    </main>
  </div>

  <!-- Floating action button -->
  <button class="fab" onclick="openEditSelector()" aria-label="Quick edit">‚úé</button>

  <!-- Bottom navigation for mobile -->
  <nav class="bottom-nav" role="navigation" aria-label="Bottom navigation">
    <button class="nav-btn" onclick="window.location.href='/'">Home</button>
    <button class="nav-btn" onclick="window.location.href='/my_profile'">Profile</button>
    <button class="nav-btn" onclick="window.location.href='/help'">Help</button>
  </nav>

  <!-- ---------- Modals & Sheets ---------- -->
  <!-- Edit selector modal (sheet) -->
  <div id="edit-selector-modal" class="modal backdrop" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="sheet" role="document">
      <div class="sheet-header">
        <strong>Choose what to edit</strong>
        <button class="modal-close" onclick="closeEditSelector()" aria-label="Close">‚úï</button>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn btn-primary" style="flex:1" onclick="openEditUserModal()">Edit User</button>
        <button class="btn btn-ghost" style="flex:1" onclick="openEditWorkerModal()">Edit Worker</button>
      </div>
    </div>
  </div>

  <!-- Edit user modal -->
  <div id="edit-modal" class="modal backdrop" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="sheet" >
      <div class="sheet-header">
        <strong>Edit User Details</strong>
        <button class="modal-close" onclick="closeEditModal()" aria-label="Close">‚úï</button>
      </div>
      <form id="edit-form" style="margin-top:12px">
        <!-- JS will inject fields -->
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn btn-primary" type="submit">Save</button>
          <button class="btn btn-ghost" type="button" onclick="closeEditModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Worker register modal -->
  <div id="worker-modal" class="modal backdrop" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="sheet-header">
        <strong>Register as Worker</strong>
        <button class="modal-close" onclick="closeWorkerModal()" aria-label="Close">‚úï</button>
      </div>
      <form id="worker-form" style="margin-top:12px">
        <!-- Typical fields - keep names identical to original handler -->
        <div class="form-group"><label for="user_id">User ID</label><input id="worker-user-id" name="user_id" type="text" readonly></div>
        <div class="form-group"><label for="role">Role</label><input id="role" name="role" /></div>
        <div class="form-group"><label for="department">Department</label><input id="department" name="department" /></div>
        <div class="form-group"><label for="position_type">Position Type</label><input id="position_type" name="position_type" /></div>
        <div class="form-group"><label for="consent">Consent</label><input id="consent-worker" name="consent" type="checkbox" /></div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn btn-primary" type="submit">Submit</button>
          <button class="btn btn-ghost" type="button" onclick="closeWorkerModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit worker modal -->
  <div id="edit-worker-modal" class="modal backdrop" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="sheet-header">
        <strong>Edit Worker Details</strong>
        <button class="modal-close" onclick="closeEditWorkerModal()" aria-label="Close">‚úï</button>
      </div>
      <form id="edit-worker-form" style="margin-top:12px">
        <!-- JS will inject worker fields -->
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn btn-primary" type="submit">Save</button>
          <button class="btn btn-ghost" type="button" onclick="closeEditWorkerModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Availability and rota sections will be injected into #rota-section -->

  <!-- ---------- Scripts (keeps your endpoints & logic intact) ---------- -->
  <script>
    // Theme handling (keeps behaviour as original)
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      try { localStorage.setItem('theme', theme); } catch(e){}
      document.querySelectorAll('.theme-toggle').forEach(btn => btn.setAttribute('aria-pressed', theme === 'dark'));
    }
    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      setTheme(current === 'dark' ? 'light' : 'dark');
    }
    const savedTheme = (function(){try{return localStorage.getItem('theme')}catch(e){return null}})();
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    setTheme(savedTheme || (prefersDark ? 'dark' : 'light'));

    // Utility: safely get from localStorage
    function safeGet(key){
      try{
        const v = localStorage.getItem(key);
        return v ? JSON.parse(v) : null;
      }catch(e){return null}
    }

    const user = safeGet('loggedInUser') || {
      details: { first_name: 'Unknown', last_name: '', email:'', contact_number:'' }
    };

    // Fill profile UI
    (function renderProfile(){
      const fullName = `${user.details?.first_name || ''} ${user.details?.last_name || ''}`.trim();
      const nameEl = document.getElementById('full-name');
      if(nameEl) nameEl.innerText = ` ${fullName || 'Unnamed User'}`;

      const avatar = document.getElementById('profile-avatar');
      if(avatar){
        // show initials or emoji
        const initials = (user.details?.first_name?.[0] || '') + (user.details?.last_name?.[0] || '');
        avatar.innerText = initials ? initials.toUpperCase() : 'üë§';
      }

      const sub = document.getElementById('profile-sub');
      if(sub) sub.innerText = user.details?.email || 'No email';

      // Contact grid - keep same content as original contact-info and contact number
      const grid = document.getElementById('contact-info-grid');
      if(grid){
        grid.innerHTML = '';
        const emailCard = document.createElement('div');
        emailCard.className = 'info-item';
        emailCard.innerHTML = `<strong>Email</strong><div>${user.details?.email || '‚Äî'}</div>`;
        const phoneCard = document.createElement('div');
        phoneCard.className = 'info-item';
        phoneCard.innerHTML = `<strong>Contact</strong><div>${user.details?.contact_number || '‚Äî'}</div>`;
        grid.appendChild(emailCard);
        grid.appendChild(phoneCard);
      }

      // Other details (filtering same excluded keys)
      const otherDiv = document.getElementById('other-details');
      if(otherDiv){
        otherDiv.innerHTML = '';
        const excluded = ["id","created_at","updated_at","first_name","last_name","email","contact_number"];
        for(const [k,v] of Object.entries(user.details || {})){
          if(!excluded.includes(k)){
            const el = document.createElement('div');
            el.className = 'info-item';
            el.style.cursor = 'pointer';
            el.innerHTML = `<strong>${k}</strong><div style="margin-top:6px">${v || '‚Äî'}</div>`;
            // Expand on tap to show a small inline detail
            el.addEventListener('click', ()=> {
              if(el.nextSibling && el.nextSibling.classList && el.nextSibling.classList.contains('detail-extra')){
                el.parentNode.removeChild(el.nextSibling);
                return;
              }
              const extra = document.createElement('div');
              extra.className = 'detail-extra';
              extra.style.padding='10px';
              extra.style.marginTop='6px';
              extra.style.borderRadius='10px';
              extra.style.background='rgba(0,0,0,0.03)';
              extra.innerText = `${k}: ${v || '‚Äî'}`;
              el.parentNode.insertBefore(extra, el.nextSibling);
            });
            otherDiv.appendChild(el);
          }
        }
      }

      // Worker section rendering (keeps original logic)
      const workerSection = document.getElementById('worker-section');
      if(workerSection){
        workerSection.innerHTML = '';
        if(!user.worker){
          const card = document.createElement('div');
          card.className = 'delete-section';
          card.innerHTML = `<h3>Worker Details</h3>
            <p style="color:crimson;margin:6px 0 8px 0">This user is not yet registered as a worker.</p>
            <div style="display:flex;gap:8px">
              <button class="btn btn-primary" onclick="openWorkerModal()">Register as Worker</button>
            </div>`;
          workerSection.appendChild(card);
          // if worker-user-id exists, set; else the worker modal's user id will get set when opened
          const runner = document.getElementById('worker-user-id');
          if(runner) runner.value = user.details?.id || '';
        } else if(user.worker_approval_status === "pending_approval"){
          const p = document.createElement('div');
          p.className = 'delete-section';
          p.innerHTML = `<h3>Worker Details</h3>
            <p style="color:orange;margin:6px 0;">
              You have registered for the position of <strong>${user.worker.role || '‚Äî'}</strong>
              in the <strong>${user.worker.department || '‚Äî'}</strong> department
              as a <strong>${user.worker.position_type || '‚Äî'}</strong>.<br><br>
              Your form has been sent for approval. Once approved, your worker details will be displayed here.
            </p>`;
          workerSection.appendChild(p);
        } else if(user.worker_approval_status === "approved"){
          const wrapper = document.createElement('div');
          wrapper.innerHTML = `
            <div class="section-title" style="margin-top:8px">
              <h3>Worker Details</h3>
              <div><button class="btn btn-ghost" onclick="toggleWorkerDetail()">üëÅ Toggle</button></div>
            </div>
            <div id="worker-details" class="collapsible"></div>
          `;
          workerSection.appendChild(wrapper);
          const workerDiv = document.getElementById('worker-details');
          workerDiv.innerHTML = '';
          const excludedWorker = ["id","worker_id","user_id","created_at","updated_at"];
          for(const [key, value] of Object.entries(user.worker || {})){
            if(!excludedWorker.includes(key)){
              const row = document.createElement('div');
              row.className = 'info-item';
              row.innerHTML = `<strong>${key}</strong><div style="margin-top:6px">${value || '‚Äî'}</div>`;
              workerDiv.appendChild(row);
            }
          }
          // Start hidden
          workerDiv.style.display = 'none';
        }
      }

      // Rota section (only show if worker approved)
      const rotaSection = document.getElementById('rota-section');
      if(rotaSection){
        rotaSection.innerHTML = '';
        if(user.worker && user.worker_approval_status === "approved"){
          rotaSection.innerHTML = `
            <div class="section-title"><h3>üìÖ ROTA</h3><span class="muted">Manage availability</span></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn btn-primary" onclick="toggleAvailability()">Provide Availabilities</button>
              <button class="btn btn-ghost" onclick="loadRota()">Show ROTA</button>
            </div>
            <div id="availability-section" class="collapsible" style="margin-top:10px"></div>
            <div id="rota-details" class="collapsible" style="margin-top:10px"></div>
          `;
        }
      }

    })();

    // toggle worker details
    function toggleWorkerDetail(){
      const div = document.getElementById('worker-details');
      if(!div) return;
      div.style.display = div.style.display === 'block' ? 'none' : 'block';
    }

    // ---------- Edit modal logic (kept same behaviour but with safe guards) ----------
    function openEditModal() {
      const form = document.getElementById("edit-form");
      if(!form) return;
      form.querySelectorAll('.form-group').forEach(n=>n.remove());
      const excluded = ["id", "created_at", "updated_at"];
      const fieldLabels = {
        first_name: "First Name",
        last_name: "Last Name",
        age: "Age",
        gender: "Gender",
        birthday: "Birthday",
        contact_number: "Contact Number",
        age_group: "Age Group",
        department: "Department",
        relationship_status: "Relationship Status",
        email: "Email",
        address: "Address",
        consent: "Consent"
      };

      for (const [key, value] of Object.entries(user.details || {})) {
        if (!excluded.includes(key)) {
          const wrapper = document.createElement("div");
          wrapper.classList.add("form-group");

          const label = document.createElement("label");
          label.setAttribute("for", key);
          label.textContent = fieldLabels[key] || key;

          let input;
          if (key === "consent") {
            input = document.createElement("input");
            input.type = "checkbox";
            input.id = key;
            input.name = key;
            input.checked = value === true || value === "true";
          } else if (key === "birthday") {
            input = document.createElement("input");
            input.type = "date";
            input.id = key;
            input.name = key;
            input.value = value || "";
          } else if (key === "age") {
            input = document.createElement("input");
            input.type = "number";
            input.id = key;
            input.name = key;
            input.value = value || 0;
          } else {
            input = document.createElement("input");
            input.type = "text";
            input.id = key;
            input.name = key;
            input.value = value || "";
          }

          wrapper.appendChild(label);
          wrapper.appendChild(input);
          // insert before action buttons
          form.insertBefore(wrapper, form.querySelector('div'));
        }
      }
      const modal = document.getElementById("edit-modal");
      if(modal) modal.style.display = "flex";
    }
    function closeEditModal() {
      const modal = document.getElementById("edit-modal");
      if(modal) modal.style.display = "none";
    }

    // submit edit form
    const editForm = document.getElementById("edit-form");
    if(editForm){
      editForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const updates = {};
        formData.forEach((v, k) => {
          if (k === "consent") {
            updates[k] = !!document.getElementById("consent") && document.getElementById("consent").checked;
          } else {
            updates[k] = v;
          }
        });

        try {
          const res = await fetch('/update_user_details', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email: user.details?.email, updates })
          });
          const data = await res.json();
          if (res.ok) {
            alert("User details updated successfully!");
            location.reload();
          } else {
            alert(data.error || 'Update failed');
          }
        } catch (err) {
          alert('Network error while updating details');
        }
      });
    }

    // ---------- Worker modal logic ----------
    function openWorkerModal(){
      const modal = document.getElementById('worker-modal');
      // set user id if available
      const uid = document.getElementById('worker-user-id');
      if(uid && user.details && user.details.id) uid.value = user.details.id;
      if(modal) modal.style.display = 'flex';
    }
    function closeWorkerModal(){ const m = document.getElementById('worker-modal'); if(m) m.style.display = 'none'; }

    const workerForm = document.getElementById('worker-form');
    if(workerForm){
      workerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const body = {};
        formData.forEach((v,k)=>body[k]=v);
        // try to preserve original consent usage (original used id "consent")
        const consentField = document.getElementById('consent') || document.getElementById('consent-worker');
        body["consent"] = !!(consentField && consentField.checked);

        try {
          const res = await fetch('/register_worker', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(body)
          });
          const data = await res.json();
          if (res.ok) {
            alert(data.message || 'Registered for worker role');
            closeWorkerModal();
            // show pending approval - mimic original update
            const workerSection = document.getElementById('worker-section');
            if(workerSection){
              workerSection.innerHTML = `
                <h3>Worker Details</h3>
                <p style="color:orange;">
                  You have registered for the position of <strong>${body.role || ''}</strong>
                  in the <strong>${body.department || ''}</strong> department
                  as a <strong>${body.position_type || ''}</strong>.<br><br>
                  Your form has been sent for approval. Once approved, your worker details will be displayed here.
                </p>
              `;
            }
          } else {
            alert(data.error || 'Worker registration failed');
          }
        } catch(err){
          alert('Network error while registering worker');
        }
      });
    }

    // ---------- Edit selector & worker edit ----------
    function openEditSelector(){ const modal=document.getElementById('edit-selector-modal'); if(modal) modal.style.display='flex'; }
    function closeEditSelector(){ const modal=document.getElementById('edit-selector-modal'); if(modal) modal.style.display='none'; }

    function openEditUserModal(){
      closeEditSelector();
      openEditModal();
    }

    function openEditWorkerModal(){
      closeEditSelector();
      const form = document.getElementById("edit-worker-form");
      if(!form) return;
      // clear previous
      form.querySelectorAll('.form-group').forEach(n=>n.remove());

      if(!user.worker){
        const wrapper = document.createElement('div');
        wrapper.className = 'form-group';
        wrapper.innerHTML = "<p style='color:red'>You are not a worker.</p>";
        form.insertBefore(wrapper, form.querySelector('div'));
        document.getElementById('edit-worker-modal').style.display = 'flex';
        return;
      }

      const workerFields = {
        date_of_birth: "Date of Birth",
        emergency_contact_name: "Emergency Contact Name",
        emergency_contact_number: "Emergency Contact Number",
        emergency_contact_relationship: "Emergency Contact Relationship",
        role: "Role",
        position_type: "Position Type",
        department: "Department",
        start_date: "Start Date",
        dbs_check_date: "DBS Check Date",
        dbs_certificate_number: "DBS Certificate Number",
        safeguarding_training_date: "Safeguarding Training Date",
        medical_conditions: "Medical Conditions",
        consent: "Consent"
      };

      for (const [key, label] of Object.entries(workerFields)) {
        const wrapper = document.createElement("div");
        wrapper.classList.add("form-group");

        const lbl = document.createElement("label");
        lbl.setAttribute("for", key);
        lbl.textContent = label;

        let input;
        if (key === "consent") {
          input = document.createElement("input");
          input.type = "checkbox";
          input.id = key;
          input.name = key;
          input.checked = user.worker[key] === true || user.worker[key] === "true";
        } else if (key.includes("date")) {
          input = document.createElement("input");
          input.type = "date";
          input.id = key;
          input.name = key;
          input.value = user.worker[key] || "";
        } else {
          input = document.createElement("input");
          input.type = "text";
          input.id = key;
          input.name = key;
          input.value = user.worker[key] || "";
        }

        wrapper.appendChild(lbl);
        wrapper.appendChild(input);
        form.insertBefore(wrapper, form.querySelector('div'));
      }

      document.getElementById("edit-worker-modal").style.display = "flex";
    }
    function closeEditWorkerModal(){ const m = document.getElementById('edit-worker-modal'); if(m) m.style.display='none'; }

    // submit worker edit
    const editWorkerForm = document.getElementById('edit-worker-form');
    if(editWorkerForm){
      editWorkerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const updates = {};
        formData.forEach((v, k) => {
          if (k === "consent") updates[k] = !!document.getElementById("consent") && document.getElementById("consent").checked;
          else updates[k] = v;
        });

        try {
          const res = await fetch("/update_worker_details", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ worker_id: user.worker?.worker_id, updates })
          });
          const data = await res.json();
          if (res.ok) {
            alert("Worker details updated successfully!");
            location.reload();
          } else {
            alert(data.error || 'Update failed');
          }
        } catch(err){
          alert('Network error while updating worker details');
        }
      });
    }

    // ---------- Delete logic (unchanged endpoints) ----------
    async function handleDelete() {
      const choice = document.getElementById("delete-option").value;
      const warningDiv = document.getElementById("delete-warning");
      if(!warningDiv) return;
      warningDiv.innerHTML = "";

      if (choice === "workers") {
        warningDiv.innerHTML = `
          Are you sure you want to delete your record from the workers/volunteers database? 
          This would mean that you are no longer interested in being a worker/volunteer at AGT.<br><br>
          <button class="btn btn-danger" onclick="confirmDelete('workers')">Yes, delete my worker record</button>
        `;
      } else if (choice === "agt") {
        warningDiv.innerHTML = `
          Are you sure you want to delete your record from the church database? 
          This will also delete your record from the workers database if you are a worker/volunteer.<br><br>
          <button class="btn btn-danger" onclick="confirmDelete('agt')">Yes, delete my AGT record</button>
        `;
      } else {
        warningDiv.innerHTML = `<span style="color:var(--muted)">Please select an option above.</span>`;
      }
    }

    async function confirmDelete(type) {
      const endpoint = "/delete_record";
      const body = { type, user_id: user.details?.id, worker_id: user.worker?.worker_id };
      try {
        const res = await fetch(endpoint, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(body)
        });
        const data = await res.json();
        alert(data.message || data.error || 'Response received');
        if (res.ok) window.location.href = "/my_profile";
      } catch(err){
        alert('Network error while deleting record');
      }
    }

    // ---------- ROTA & Availability (kept functionality) ----------
    if (user.worker && user.worker_approval_status === "approved") {
      // nothing else needed here ‚Äî UI injected earlier
    }

    async function loadRota() {
      const rotaDiv = document.getElementById("rota-details");
      if(!rotaDiv) return;
      if (rotaDiv.style.display === "block") {
        rotaDiv.style.display = "none"; return;
      }
      rotaDiv.innerHTML = "‚è≥ Loading...";
      try {
        const res = await fetch(`/get_rota/${user.worker?.worker_id}`);
        const data = await res.json();
        rotaDiv.innerHTML = "";
        if(Array.isArray(data) && data.length){
          data.forEach(r => {
            const row = document.createElement("div");
            row.classList.add("info-item");
            row.innerHTML = `
              <strong>${r.month || '‚Äî'}</strong> - ${r.service_date || '‚Äî'}, ${r.service_slot || '‚Äî'}<br>
              Availability: ${r.availability || '‚Äî'} | Assignment: ${r.assignment || '‚Äî'}<br>
              Status: <em>${r.approval_status || '‚Äî'}</em>
            `;
            rotaDiv.appendChild(row);
          });
        } else {
          rotaDiv.innerHTML = '<div class="info-item">No rota entries found.</div>';
        }
        rotaDiv.style.display = "block";
      } catch(err){
        rotaDiv.innerHTML = '<div class="info-item">Failed to load rota.</div>';
      }
    }

    function toggleAvailability() {
      const section = document.getElementById("availability-section");
      if(!section) return;
      if (section.style.display === "block") {
        section.style.display = "none";
        return;
      }
      renderCalendar(new Date().getMonth(), new Date().getFullYear());
      section.style.display = "block";
    }

    function renderCalendar(month, year) {
      const section = document.getElementById("availability-section");
      if(!section) return;

      const monthNames = [
        "January","February","March","April","May","June",
        "July","August","September","October","November","December"
      ];

      let monthOptions = "";
      monthNames.forEach((m, idx) => {
        monthOptions += `<option value="${idx}" ${idx === month ? "selected" : ""}>${m}</option>`;
      });

      const currentYear = new Date().getFullYear();
      let yearOptions = "";
      for (let y = currentYear; y <= currentYear + 5; y++) {
        yearOptions += `<option value="${y}" ${y === year ? "selected" : ""}>${y}</option>`;
      }

      const firstDay = new Date(year, month, 1).getDay(); // 0=Sun
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const startDay = (firstDay === 0 ? 6 : firstDay - 1);

      let calendarHtml = `
        <div class="calendar-controls">
          <select id="month-select">${monthOptions}</select>
          <select id="year-select">${yearOptions}</select>
          <div style="flex:1"></div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;font-size:12px;margin-bottom:6px;text-align:center;font-weight:700;">
          <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
        </div>
        <div class="calendar-grid">
      `;

      for (let i = 0; i < startDay; i++) calendarHtml += `<div></div>`;

      for (let d = 1; d <= daysInMonth; d++) {
        calendarHtml += `
          <label class="calendar-cell">
            <div>${d}</div>
            <input type="checkbox" value="${d}">
          </label>
        `;
      }
      calendarHtml += `</div><div style="margin-top:12px"><button class="btn btn-primary" onclick="saveAvailability()">Save Availability</button></div>`;
      section.innerHTML = calendarHtml;

      document.getElementById("month-select").addEventListener("change", () => {
        const newMonth = parseInt(document.getElementById("month-select").value, 10);
        const newYear = parseInt(document.getElementById("year-select").value, 10);
        renderCalendar(newMonth, newYear);
      });
      document.getElementById("year-select").addEventListener("change", () => {
        const newMonth = parseInt(document.getElementById("month-select").value, 10);
        const newYear = parseInt(document.getElementById("year-select").value, 10);
        renderCalendar(newMonth, newYear);
      });
    }

    async function saveAvailability() {
      const monthIdx = parseInt(document.getElementById("month-select").value, 10);
      const year = parseInt(document.getElementById("year-select").value, 10);
      const monthName = new Date(year, monthIdx).toLocaleString("default", { month: "long" });

      const checkboxes = document.querySelectorAll("#availability-section input[type=checkbox]:checked");
      if (checkboxes.length === 0) {
        alert("Please select at least one day");
        return;
      }

      const availability = Array.from(checkboxes).map(cb => {
        let day = parseInt(cb.value, 10);
        let suffix = "th";
        if (day % 10 === 1 && day !== 11) suffix = "st";
        else if (day % 10 === 2 && day !== 12) suffix = "nd";
        else if (day % 10 === 3 && day !== 13) suffix = "rd";
        return `${day}${suffix}`;
      });

      const body = {
        worker_id: user.worker?.worker_id,
        month: `${monthName} ${year}`,
        availability: availability
      };

      try {
        const res = await fetch("/rota/save_availability", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(body)
        });

        const data = await res.json();
        if (res.ok) {
          alert("Availability saved successfully!");
          document.getElementById("availability-section").style.display = "none";
        } else {
          alert(data.error || 'Save failed');
        }
      } catch(err){
        alert('Network error while saving availability');
      }
    }

    // Close modals when tapping backdrop
    document.querySelectorAll('.modal.backdrop').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.style.display = 'none';
      });
    });

  </script>
</body>
</html>
