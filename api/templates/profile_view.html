<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Profile | AGT</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #20c997;
      --primary-hover: #198754;
      --bg: #f8f9fa;
      --card: #ffffff;
      --text: #212529;
    }

    [data-theme="dark"] {
      --bg: #1e1e2f;
      --card: #2a2a3d;
      --text: #f8f9fa;
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
      min-height: 100vh;
      background-image: url('https://github.com/Tunnox/Images/blob/main/AGT_profile_page_BG.jpg?raw=true');
      background-size: cover;
      background-position: center;
      backdrop-filter: blur(6px);
    }

    .card {
      background: var(--card);
      border-radius: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      padding: 30px;
      max-width: 600px;
      width: 100%;
      text-align: center;
      margin-top: 40px;
      animation: fadeIn 0.4s ease;
    }

    h2 { margin-bottom: 12px; }
    h3 { margin-top: 20px; margin-bottom: 10px; color: var(--primary-hover); }

    .details { text-align: left; margin-top: 10px; }
    .details div { margin-bottom: 8px; font-size: 15px; }
    .details strong { color: var(--primary); }

    .back-btn, .edit-btn {
      margin-top: 20px;
      padding: 12px 20px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      background-color: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .edit-btn { margin-left: 10px; }
    .back-btn:hover, .edit-btn:hover { background-color: var(--primary-hover); }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .modal-content {
      background: var(--card);
      padding: 24px;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      text-align: left;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-content h3 { margin-top: 0; }
    .modal-actions { text-align: right; margin-top: 10px; }
    .modal-actions button {
      padding: 10px 16px;
      margin-left: 10px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    .save-btn { background-color: var(--primary); color: white; }
    .cancel-btn { background-color: #dee2e6; color: #333; }

    /* Form Styling */
    .form-group { margin-bottom: 15px; display: flex; flex-direction: column; }
    .form-group label { font-weight: 600; margin-bottom: 5px; }
    .form-group input, .form-group textarea {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }

    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(20px);}
      to {opacity: 1; transform: translateY(0);}
    }

    /* Collapsible sections */
    .collapsible-btn {
      background: var(--primary);
      color: white;
      padding: 10px 16px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      text-align: left;
      margin-top: 10px;
      transition: background 0.3s ease;
    }
    .collapsible-btn:hover {
      background: var(--primary-hover);
    }

    .collapsible-content {
      display: none;
      margin-top: 12px;
      padding: 15px;
      border-radius: 12px;
      background: var(--bg);
      box-shadow: inset 0 0 6px rgba(0,0,0,0.1);
    }

    /* Delete Section */
    .delete-section {
      margin-top: 25px;
      padding: 15px;
      border-radius: 12px;
      background: var(--card);
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    .delete-section select, .delete-section button {
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 10px;
      font-size: 14px;
    }
    .delete-section button {
      background: crimson;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s ease;
    }
    .delete-section button:hover {
      background: darkred;
    }
    .warning {
      color: crimson;
      font-size: 14px;
      margin-top: 12px;
      font-weight: 600;
      line-height: 1.5;
    }

    /* ROTA Section */
    .rota-entry {
      background: var(--card);
      border: 1px solid #e9ecef;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      font-size: 14px;
    }
    .rota-entry strong {
      color: var(--primary-hover);
    }

  </style>
</head>
<body>
  <div class="card">
    <h2 id="full-name"></h2>
    <div id="contact-info" class="details"></div>
    <h3>Other Details</h3>
    <div class="details" id="other-details"></div>

    <div id="worker-section" style="margin-top:20px;"></div>
    <div id="rota-section" style="margin-top:20px;"></div>

    <div id="rota-section" style="margin-top:20px;"></div>

    <div class="delete-section">
      <h3>üóë Delete Your Record</h3>
      <p>Select where to delete your record from:</p>
      <select id="delete-option">
        <option value="">-- Select Database --</option>
        <option value="agt">AGT database</option>
        <option value="workers">AGT Workers database</option>
      </select>
      <button onclick="handleDelete()">Delete</button>
      <div id="delete-warning" class="warning"></div>
    </div>


    <div>
      <button class="back-btn" onclick="window.location.href='/my_profile'">‚Üê Back to Login</button>
      <button class="edit-btn" onclick="openEditSelector()">‚úé Edit</button>
    </div>
    
  </div>

  <!-- Edit Selector Modal -->
<div id="edit-selector-modal" class="modal">
  <div class="modal-content">
    <h3>Edit Record</h3>
    <p>Select which record you want to edit:</p>
    <div class="modal-actions">
      <button class="save-btn" onclick="openEditUserModal()">AGT Database</button>
      <button class="save-btn" onclick="openEditWorkerModal()">Worker Database</button>
      <button class="cancel-btn" onclick="closeEditSelector()">Cancel</button>
    </div>
  </div>
</div>


  <!-- Edit Modal -->
  <div id="edit-modal" class="modal">
    <div class="modal-content">
      <h3>Edit User Details</h3>
      <form id="edit-form"></form>
      <div class="modal-actions">
        <button type="button" class="cancel-btn" onclick="closeEditModal()">Cancel</button>
        <button type="submit" class="save-btn" form="edit-form">Save</button>
      </div>
    </div>
  </div>

  <!-- Worker Edit Modal -->
<div id="edit-worker-modal" class="modal">
  <div class="modal-content">
    <h3>Edit Worker Details</h3>
    <form id="edit-worker-form"></form>
    <div class="modal-actions">
      <button type="button" class="cancel-btn" onclick="closeEditWorkerModal()">Cancel</button>
      <button type="submit" class="save-btn" form="edit-worker-form">Save</button>
    </div>
  </div>
</div>


  <!-- Worker Modal -->
  <div id="worker-modal" class="modal">
    <div class="modal-content">
      <h3>Register as Worker</h3>
      <form id="worker-form">
        <input type="hidden" name="user_id" id="worker-user-id">

        <div class="form-group">
          <label for="date_of_birth">Date of Birth</label>
          <input type="date" id="date_of_birth" name="date_of_birth" required>
        </div>
        <div class="form-group">
          <label for="emergency_contact_name">Emergency Contact Name</label>
          <input type="text" id="emergency_contact_name" name="emergency_contact_name" required>
        </div>
        <div class="form-group">
          <label for="emergency_contact_number">Emergency Contact Number</label>
          <input type="text" id="emergency_contact_number" name="emergency_contact_number" required>
        </div>
        <div class="form-group">
          <label for="emergency_contact_relationship">Emergency Contact Relationship</label>
          <input type="text" id="emergency_contact_relationship" name="emergency_contact_relationship" required>
        </div>
        <div class="form-group">
          <label for="role">Role</label>
          <input type="text" id="role" name="role" required>
        </div>
        <div class="form-group">
          <label for="position_type">Position Type</label>
          <select id="position_type" name="position_type" required>
            <option value="Worker">Worker</option>
            <option value="Volunteer">Volunteer</option>
            <option value="Adhoc">Adhoc</option>
          </select>
        </div>
        <div class="form-group">
          <label for="department">Department</label>
          <select id="department" name="department" required>
            <option value="Choir">Choir</option>
            <option value="Ushering">Ushering</option>
            <option value="Technical">Technical</option>
            <option value="Security">Security</option>
          </select>
        </div>
        <div class="form-group">
          <label for="start_date">Start Date</label>
          <input type="date" id="start_date" name="start_date" required>
        </div>
        <div class="form-group">
          <label for="dbs_check_date">DBS Check Date</label>
          <input type="date" id="dbs_check_date" name="dbs_check_date">
        </div>
        <div class="form-group">
          <label for="dbs_certificate_number">DBS Certificate Number</label>
          <input type="text" id="dbs_certificate_number" name="dbs_certificate_number">
        </div>
        <div class="form-group">
          <label for="safeguarding_training_date">Safeguarding Training Date</label>
          <input type="date" id="safeguarding_training_date" name="safeguarding_training_date">
        </div>
        <div class="form-group">
          <label for="medical_conditions">Medical Conditions</label>
          <textarea id="medical_conditions" name="medical_conditions"></textarea>
        </div>
        <div class="form-group">
          <label><input type="checkbox" id="consent" name="consent"> Consent</label>
        </div>

        <div class="modal-actions">
          <button type="button" class="cancel-btn" onclick="closeWorkerModal()">Cancel</button>
          <button type="submit" class="save-btn">Save</button>
        </div>
      </form>
    </div>
  </div>

<script>
  const user = JSON.parse(localStorage.getItem('loggedInUser'));

  // Display header and details
  const fullName = `${user.details.first_name} ${user.details.last_name}`;
  document.getElementById("full-name").innerText = ` üë§${fullName}`;

  document.getElementById("contact-info").innerHTML = `
    <div><strong>Email:</strong> ${user.details.email}</div>
    <div><strong>Contact Number:</strong> ${user.details.contact_number}</div>
  `;

  const otherDiv = document.getElementById("other-details");
  const excluded = ["id", "created_at", "updated_at", "first_name", "last_name", "email", "contact_number"];
  for (const [key, value] of Object.entries(user.details)) {
    if (!excluded.includes(key)) {
      const row = document.createElement("div");
      row.innerHTML = `<strong>${key}</strong>: ${value}`;
      otherDiv.appendChild(row);
    }
  }

  // Worker Section
  const workerSection = document.getElementById('worker-section');
    if (!user.worker) {
    workerSection.innerHTML = `
      <h3>Worker Details</h3>
      <p style="color:red;">This user is not yet registered as a worker.</p>
      <button onclick="openWorkerModal()">Register as Worker</button>
    `;
    document.getElementById('worker-user-id').value = user.details.id;
  } else if (user.worker_approval_status === "pending_approval") {
    workerSection.innerHTML = `
      <h3>Worker Details</h3>
      <p style="color:orange;">
        You have registered for the position of <strong>${user.worker.role}</strong>
        in the <strong>${user.worker.department}</strong> department
        as a <strong>${user.worker.position_type}</strong>.<br><br>
        Your form has been sent for approval. Once approved, your worker details will be displayed here, 
        and you can modify where needed.
      </p>
    `;
    } else if (user.worker_approval_status === "approved") {
    workerSection.innerHTML = `
      <h3>Worker Details</h3>
      <button class="collapsible-btn" onclick="toggleWorkerDetail()">üë§ Show Worker Detail</button>
      <div id="worker-details" class="collapsible-content"></div>
    `;
    const workerDiv = document.getElementById("worker-details");
    const excludedWorker = ["id", "worker_id", "user_id", "created_at", "updated_at"];
    for (const [key, value] of Object.entries(user.worker)) {
      if (!excludedWorker.includes(key)) {
        const row = document.createElement("div");
        row.innerHTML = `<strong>${key}</strong>: ${value}`;
        workerDiv.appendChild(row);
      }
    }
  }

  function toggleWorkerDetail() {
    const div = document.getElementById("worker-details");
    div.style.display = div.style.display === "none" ? "block" : "none";
  }



  // Edit Modal Logic
  function openEditModal() {
    const form = document.getElementById("edit-form");
    form.innerHTML = "";
    const excluded = ["id", "created_at", "updated_at"];
    const fieldLabels = {
      first_name: "First Name",
      last_name: "Last Name",
      age: "Age",
      gender: "Gender",
      birthday: "Birthday",
      contact_number: "Contact Number",
      age_group: "Age Group",
      department: "Department",
      relationship_status: "Relationship Status",
      email: "Email",
      address: "Address",
      consent: "Consent"
    };

    for (const [key, value] of Object.entries(user.details)) {
      if (!excluded.includes(key)) {
        const wrapper = document.createElement("div");
        wrapper.classList.add("form-group");

        const label = document.createElement("label");
        label.setAttribute("for", key);
        label.textContent = fieldLabels[key] || key;

        let input;
        if (key === "consent") {
          input = document.createElement("input");
          input.type = "checkbox";
          input.id = key;
          input.name = key;
          input.checked = value === true || value === "true";
        } else if (key === "birthday") {
          input = document.createElement("input");
          input.type = "date";
          input.id = key;
          input.name = key;
          input.value = value || "";
        } else if (key === "age") {
          input = document.createElement("input");
          input.type = "number";
          input.id = key;
          input.name = key;
          input.value = value || 0;
        } else {
          input = document.createElement("input");
          input.type = "text";
          input.id = key;
          input.name = key;
          input.value = value || "";
        }

        wrapper.appendChild(label);
        wrapper.appendChild(input);
        form.appendChild(wrapper);
      }
    }
    document.getElementById("edit-modal").style.display = "flex";
  }
  function closeEditModal() {
    document.getElementById("edit-modal").style.display = "none";
  }

  document.getElementById("edit-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const updates = {};
    formData.forEach((v, k) => {
      if (k === "consent") updates[k] = document.getElementById("consent").checked;
      else updates[k] = v;
    });

    const res = await fetch('/update_user_details', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ email: user.details.email, updates })
    });

    const data = await res.json();
    if (res.ok) {
      alert("User details updated successfully!");
      location.reload();
    } else {
      alert(data.error);
    }
  });

  // Worker Modal Logic
  function openWorkerModal() {
    document.getElementById('worker-modal').style.display = 'flex';
  }
  function closeWorkerModal() {
    document.getElementById('worker-modal').style.display = 'none';
  }

  document.getElementById('worker-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const body = {};
    formData.forEach((v,k)=>body[k]=v);
    body["consent"] = document.getElementById("consent").checked;

    const res = await fetch('/register_worker', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });

    const data = await res.json();
    if (res.ok) {
      alert(data.message);
      closeWorkerModal();

      workerSection.innerHTML = `
        <h3>Worker Details</h3>
        <p style="color:orange;">
          You have registered for the position of <strong>${body.role}</strong>
          in the <strong>${body.department}</strong> department
          as a <strong>${body.position_type}</strong>.<br><br>
          Your form has been sent for approval. Once approved, your worker details will be displayed here, 
          and you can modify where needed.
        </p>
      `;
    }
    else {
          alert(data.error);
        }
      });

      // --------- Selector Modal Logic ---------
function openEditSelector() {
  document.getElementById("edit-selector-modal").style.display = "flex";
}
function closeEditSelector() {
  document.getElementById("edit-selector-modal").style.display = "none";
}

// --------- AGT User Edit (existing) ---------
function openEditUserModal() {
  closeEditSelector();
  openEditModal(); // already defined
}

// --------- Worker Edit ---------
function openEditWorkerModal() {
  closeEditSelector();
  const form = document.getElementById("edit-worker-form");
  form.innerHTML = "";

  if (!user.worker) {
    form.innerHTML = "<p style='color:red'>You are not a worker.</p>";
    return;
  }

  const workerFields = {
    date_of_birth: "Date of Birth",
    emergency_contact_name: "Emergency Contact Name",
    emergency_contact_number: "Emergency Contact Number",
    emergency_contact_relationship: "Emergency Contact Relationship",
    role: "Role",
    position_type: "Position Type",
    department: "Department",
    start_date: "Start Date",
    dbs_check_date: "DBS Check Date",
    dbs_certificate_number: "DBS Certificate Number",
    safeguarding_training_date: "Safeguarding Training Date",
    medical_conditions: "Medical Conditions",
    consent: "Consent"
  };

  for (const [key, label] of Object.entries(workerFields)) {
    const wrapper = document.createElement("div");
    wrapper.classList.add("form-group");

    const lbl = document.createElement("label");
    lbl.setAttribute("for", key);
    lbl.textContent = label;

    let input;
    if (key === "consent") {
      input = document.createElement("input");
      input.type = "checkbox";
      input.id = key;
      input.name = key;
      input.checked = user.worker[key] === true || user.worker[key] === "true";
    } else if (key.includes("date")) {
      input = document.createElement("input");
      input.type = "date";
      input.id = key;
      input.name = key;
      input.value = user.worker[key] || "";
    } else {
      input = document.createElement("input");
      input.type = "text";
      input.id = key;
      input.name = key;
      input.value = user.worker[key] || "";
    }

    wrapper.appendChild(lbl);
    wrapper.appendChild(input);
    form.appendChild(wrapper);
  }

  document.getElementById("edit-worker-modal").style.display = "flex";
}
function closeEditWorkerModal() {
  document.getElementById("edit-worker-modal").style.display = "none";
}

// --------- Submit Worker Form ---------
document.getElementById("edit-worker-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const updates = {};
  formData.forEach((v, k) => {
    if (k === "consent") updates[k] = document.getElementById("consent").checked;
    else updates[k] = v;
  });

  const res = await fetch("/update_worker_details", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ worker_id: user.worker.worker_id, updates })
  });

  const data = await res.json();
  if (res.ok) {
    alert("Worker details updated successfully!");
    location.reload();
  } else {
    alert(data.error);
  }
});

</script>
<script>
async function handleDelete() {
  const choice = document.getElementById("delete-option").value;
  const warningDiv = document.getElementById("delete-warning");
  warningDiv.innerHTML = "";

  if (choice === "workers") {
    warningDiv.innerHTML = `
      Are you sure you want to delete your record from the workers/volunteers database? 
      This would mean that you are no longer interested in being a worker/volunteer at AGT.<br>
      <button onclick="confirmDelete('workers')">Yes, please delete my record</button>
    `;
  } else if (choice === "agt") {
    warningDiv.innerHTML = `
      Are you sure you want to delete your record from the church database? 
      This will also delete your record from the workers database if you are a worker/volunteer.<br>
      <button onclick="confirmDelete('agt')">Yes, please delete my record</button>
    `;
  }
}

async function confirmDelete(type) {
  const endpoint = "/delete_record";
  const body = { type, user_id: user.details.id, worker_id: user.worker?.worker_id };
  const res = await fetch(endpoint, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(body)
  });
  const data = await res.json();
  alert(data.message || data.error);
  if (res.ok) window.location.href = "/my_profile";
}
</script>

<script>
if (user.worker && user.worker_approval_status === "approved") {
  const rotaSection = document.getElementById("rota-section");
  rotaSection.innerHTML = `
    <h3>üìÖ ROTA</h3>
    <button class="collapsible-btn" onclick="toggleAvailability()">Provide Your Availabilities</button>
    <div id="availability-section" class="collapsible-content"></div>
    <button class="collapsible-btn" onclick="loadRota()">Show ROTA</button>
    <div id="rota-details" class="collapsible-content"></div>
  `;
}


async function loadRota() {
  const rotaDiv = document.getElementById("rota-details");
  if (rotaDiv.style.display === "block") {
    rotaDiv.style.display = "none"; return;
  }
  rotaDiv.innerHTML = "‚è≥ Loading...";
  const res = await fetch(`/get_rota/${user.worker.worker_id}`);
  const data = await res.json();
  rotaDiv.innerHTML = "";
  data.forEach(r => {
    const row = document.createElement("div");
    row.classList.add("rota-entry");
    row.innerHTML = `
      <strong>${r.month}</strong> - ${r.service_date}, ${r.service_slot}<br>
      Availability: ${r.availability} | Assignment: ${r.assignment}<br>
      Status: <em>${r.approval_status}</em>
    `;
    rotaDiv.appendChild(row);
  });
  rotaDiv.style.display = "block";
}

function toggleAvailability() {
  const section = document.getElementById("availability-section");
  if (section.style.display === "block") {
    section.style.display = "none"; 
    return;
  }

  // Render calendar UI with month/year selector
  renderCalendar(new Date().getMonth(), new Date().getFullYear());
  section.style.display = "block";
}

function renderCalendar(month, year) {
  const section = document.getElementById("availability-section");

  const monthNames = [
    "January","February","March","April","May","June",
    "July","August","September","October","November","December"
  ];

  // Month selector
  let monthOptions = "";
  monthNames.forEach((m, idx) => {
    monthOptions += `<option value="${idx}" ${idx === month ? "selected" : ""}>${m}</option>`;
  });

  // Year selector (current year ‚Üí +5 future years)
  const currentYear = new Date().getFullYear();
  let yearOptions = "";
  for (let y = currentYear; y <= currentYear + 5; y++) {
    yearOptions += `<option value="${y}" ${y === year ? "selected" : ""}>${y}</option>`;
  }

  // Get first day of month + days count
  const firstDay = new Date(year, month, 1).getDay(); // 0=Sun, 1=Mon...
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  // Adjust Sunday=0 to appear last in Mon‚ÄìSun grid
  const startDay = (firstDay === 0 ? 6 : firstDay - 1);

  // Build calendar grid
  let calendarHtml = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <select id="month-select">${monthOptions}</select>
      <select id="year-select">${yearOptions}</select>
    </div>
    <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;text-align:center;font-weight:bold;margin-bottom:6px;">
      <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;">
  `;

  // Empty slots before first day
  for (let i = 0; i < startDay; i++) {
    calendarHtml += `<div></div>`;
  }

  // Days of month
  for (let d = 1; d <= daysInMonth; d++) {
    calendarHtml += `
      <label style="display:flex;flex-direction:column;align-items:center;font-size:12px;">
        ${d}
        <input type="checkbox" value="${d}" style="margin-top:4px;">
      </label>
    `;
  }
  calendarHtml += "</div><br><button class='save-btn' onclick='saveAvailability()'>Save Availability</button>";

  section.innerHTML = calendarHtml;

  // Bind dropdowns to re-render
  document.getElementById("month-select").addEventListener("change", () => {
    const newMonth = parseInt(document.getElementById("month-select").value, 10);
    const newYear = parseInt(document.getElementById("year-select").value, 10);
    renderCalendar(newMonth, newYear);
  });
  document.getElementById("year-select").addEventListener("change", () => {
    const newMonth = parseInt(document.getElementById("month-select").value, 10);
    const newYear = parseInt(document.getElementById("year-select").value, 10);
    renderCalendar(newMonth, newYear);
  });
}

async function saveAvailability() {
  const monthIdx = parseInt(document.getElementById("month-select").value, 10);
  const year = parseInt(document.getElementById("year-select").value, 10);
  const monthName = new Date(year, monthIdx).toLocaleString("default", { month: "long" });

  const checkboxes = document.querySelectorAll("#availability-section input[type=checkbox]:checked");
  if (checkboxes.length === 0) {
    alert("Please select at least one day");
    return;
  }

  const availability = Array.from(checkboxes).map(cb => {
    let day = parseInt(cb.value, 10);
    let suffix = "th";
    if (day % 10 === 1 && day !== 11) suffix = "st";
    else if (day % 10 === 2 && day !== 12) suffix = "nd";
    else if (day % 10 === 3 && day !== 13) suffix = "rd";
    return `${day}${suffix}`;
  });

  const body = {
    worker_id: user.worker.worker_id,
    month: `${monthName} ${year}`,
    availability: availability
  };

  const res = await fetch("/rota/save_availability", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(body)
  });

  const data = await res.json();
  if (res.ok) {
    alert("Availability saved successfully!");
    document.getElementById("availability-section").style.display = "none";
  } else {
    alert(data.error);
  }
}


</script>

</body>
</html>
