<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AGT Children Department</title>

  <!-- Fonts & Libraries -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet"/>
  <style>
    body {
      background: url('https://github.com/Tunnox/Images/blob/main/Children_Background.jpg?raw=true') no-repeat center center/cover;
      font-family: 'Poppins', sans-serif;
      color: white;
      scroll-behavior: smooth;
    }
    nav {
      background: rgba(0,0,0,0.7);
    }
    nav .nav-link {
      color: #ccc;
    }
    nav .nav-link:hover {
      color: #20c997;
    }
    section {
      background: rgba(0, 0, 0, 0.7);
      padding: 2rem;
      border-radius: 1rem;
      margin: 2rem auto;
      max-width: 900px;
    }
    .btn {
      background-color: #20c997;
      border: none;
      transition: 0.3s;
    }
    .btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 10px #20c997aa;
    }
    .glass-card {
      background: rgba(255,255,255,0.95);
      color: #000;
      padding: 20px;
      border-radius: 1rem;
    }
    .search-result-item {
      cursor: pointer;
      padding: 8px 12px;
      background: #fff;
      margin-bottom: 5px;
      border-radius: 5px;
      color: #000;
    }
    .search-result-item:hover {
      background: #20c997;
      color: white;
    }
    /* Navigation */
    .navbar {
      background-color: #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 15px 20px;
      position: sticky;
      top: 0;
      z-index: 999;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .nav-brand {
      font-size: 20px;
      font-weight: bold;
      color: #04395E;
    }

    .nav-toggle {
      display: none;
      font-size: 24px;
      cursor: pointer;
      background: none;
      border: none;
      color: #04395E;
    }

    .nav-links {
      display: flex;
      gap: 12px;
    }

    .nav-links a {
      text-decoration: none;
      color: #04395E;
      padding: 8px 14px;
      border-radius: 6px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .nav-links a:hover {
      background-color: #20c997;
      color: white;
      transform: scale(1.05);
    }

    @media (max-width: 768px) {
      .nav-links {
        flex-direction: column;
        background-color: #fff;
        position: absolute;
        top: 60px;
        right: 20px;
        width: 200px;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: none;
      }

      .nav-links.open {
        display: flex;
      }

      .nav-toggle {
        display: block;
      }
    }
    #childRollCallPresent {
    background-color: black !important;
    border: 2px solid #fff;
    width: 1.2em;
    height: 1.2em;
  }

  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-brand">AGT Sheffield</div>
    <button class="nav-toggle" onclick="document.querySelector('.nav-links').classList.toggle('open')">&#9776;</button>
    <div class="nav-links">
      <a href="/">Home</a>
      <a href="/my_profile">My Profile</a>
      <a href="https://www.rccgamazinggracesheffield.org/about-us/">About</a>
      <a href="https://www.rccgamazinggracesheffield.org/contact/">Contact</a>
      <a href="/login_admin">Admin Center</a>
    </div>
  </nav>


<header class="text-center mt-4">
  <img src="https://github.com/Tunnox/Images/blob/main/newlogo.png?raw=true" height="50">
  <h1>AGT SmartRecord App - Children Department</h1>
  <p>Amazing Grace Tabernacle Sheffield | In line with UK GDPR</p>
</header>

<section id="create" data-aos="fade-up">
  <h2>Create New Record</h2>
  <button class="btn" data-bs-toggle="modal" data-bs-target="#createModal">+ Add Record</button>
</section>

<!-- Create Record Modal -->
<div class="modal fade" id="createModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content p-4">
      <h5 class="modal-title">Child Data Entry Form</h5>
      <ul class="nav nav-tabs mb-3" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab1">Child Info</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab2">Parent/Consent</button></li>
      </ul>
      <form action="/childrens_church/insert" method="POST">
        <div class="tab-content">
          <div class="tab-pane fade show active" id="tab1">
            <input class="form-control mb-2" name="first_name" placeholder="First Name" required>
            <input class="form-control mb-2" name="last_name" placeholder="Last Name" required>
            <input class="form-control mb-2" name="age" type="number" placeholder="Age" required>
            <select class="form-select mb-2" name="gender" required>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="tab-pane fade" id="tab2">
            <input class="form-control mb-2" name="birthday" placeholder="Birthday" required>
            <input class="form-control mb-2" name="contact_number" placeholder="Contact Number" required>
            <select class="form-select mb-2" name="age_group" required>
              <option>Child: 0-5</option>
              <option>Child: 6-8</option>
              <option>Child: 9-12</option>
            </select>
            <label class="form-check-label">
              <input type="checkbox" class="form-check-input" name="consent" value="Yes" required> I consent to data processing in line with UK GDPR.
            </label>
          </div>
        </div>
        <div class="text-end">
          <button type="submit" class="btn mt-3">Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>

<section id="search" data-aos="fade-up">
  <h2>Search Records</h2>
  <input type="text" id="searchInput" class="form-control" placeholder="Search by name, age, etc...">
  <div id="searchResults" class="mt-3"></div>
  <div id="recordDetails" class="mt-4 d-none"></div>
</section>

<!-- Update Modal -->
<div class="modal fade" id="updateModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content p-4">
      <h5 class="modal-title">Update Record</h5>
      <form id="updateForm" method="POST" action="/childrens_church/update" class="row g-3">
        <input type="hidden" name="original_id" id="update_id">
        <div class="col-md-6"><input name="first_name" id="update_first_name" class="form-control" required></div>
        <div class="col-md-6"><input name="last_name" id="update_last_name" class="form-control" required></div>
        <div class="col-md-4"><input name="age" id="update_age" type="number" class="form-control" required></div>
        <div class="col-md-4">
          <select name="gender" id="update_gender" class="form-select" required>
            <option>Male</option><option>Female</option><option>Other</option>
          </select>
        </div>
        <div class="col-md-4"><input name="birthday" id="update_birthday" class="form-control" required></div>
        <div class="col-md-6"><input name="contact_number" id="update_contact" class="form-control" required></div>
        <div class="col-md-6">
          <select name="age_group" id="update_age_group" class="form-select" required>
            <option>Child: 0-5</option>
            <option>Child: 6-8</option>
            <option>Child: 9-12</option>
          </select>
        </div>
        <div class="col-md-12">
          <select name="consent" id="update_consent" class="form-select" required>
            <option>Yes</option><option>No</option>
          </select>
        </div>
        <div class="text-end mt-3">
          <button type="submit" class="btn">Submit Updates</button>
        </div>
      </form>
    </div>
  </div>
</div>

<section id="attendance" data-aos="fade-up">
  <h2>Take Attendance</h2>
  <input type="text" id="attendanceSearchInput" class="form-control mb-2" placeholder="Search by child name..." />
  <div id="attendanceSearchResults" class="mt-2"></div>
  <div id="selectedRecord" class="glass-card d-none mt-3">
    <h5 id="selectedName"></h5>
    <p id="selectedContact"></p>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="markPresent">
      <label class="form-check-label" for="markPresent">Mark as Present</label>
    </div>
    <button class="btn mt-3" id="submitAttendance">Take Attendance</button>
  </div>
</section>
  
  <!-- ROLL CALL FOR CHILDREN BY AGE GROUP -->
<section id="child-rollcall" data-aos="fade-up" class="mt-5">
  <h2>ðŸŽ¯ Children Roll Call</h2>
  <select id="ageGroupSelect" class="form-select mb-3">
    <option value="">-- Select Age Group --</option>
    <option value="0-5">Ages 0-5</option>
    <option value="6-8">Ages 6-8</option>
    <option value="9-12">Ages 9-12</option>
  </select>
  <div id="childRollCallCard" class="glass-card text-center d-none">
    <h4 id="childRollCallName">Loading...</h4>
    <p>
      <input class="form-check-input" type="checkbox" id="childRollCallPresent">
      <label for="childRollCallPresent" class="form-check-label ms-2">Mark Present</label>
    </p>
    <p id="childRollCallAlreadyMarked" class="text-warning mt-2"></p>
    <button class="btn btn-primary" id="childNextRollCall">Next Name</button>
  </div>
</section>

<script>
let childRollCallList = [], childRollCallIndex = 0;

function checkChildAttendance(name) {
  return fetch('/teens_check_attendance', { // reuse existing check
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name })
  }).then(res => res.json());
}

document.getElementById('ageGroupSelect').addEventListener('change', function () {
  const group = this.value;
  if (!group) return;

  fetch(`/get_children_by_age_group?group=${group}`)
    .then(res => res.json())
    .then(data => {
      childRollCallList = data;
      childRollCallIndex = 0;
      document.getElementById('childRollCallCard').classList.remove('d-none');
      showChildRollCallName();
    });
});

function showChildRollCallName() {
  const display = document.getElementById('childRollCallName');
  const checkbox = document.getElementById('childRollCallPresent');
  const alertMsg = document.getElementById('childRollCallAlreadyMarked');

  if (childRollCallIndex >= childRollCallList.length) {
    display.innerText = "ðŸŽ‰ Roll call complete!";
    checkbox.style.display = 'none';
    document.getElementById('childNextRollCall').disabled = true;
    alertMsg.innerText = '';
    return;
  }

  const current = childRollCallList[childRollCallIndex];
  display.innerText = current.name;
  checkbox.checked = false;
  checkbox.disabled = false;
  checkbox.style.display = 'inline-block';
  alertMsg.innerText = '';

  checkChildAttendance(current.name).then(result => {
    if (result.present) {
      checkbox.checked = true;
      checkbox.disabled = true;
      alertMsg.innerText = `âœ… Already marked present on ${result.date}`;
    }
  });
}

document.getElementById('childNextRollCall').addEventListener('click', function () {
  const checkbox = document.getElementById('childRollCallPresent');

  if (childRollCallIndex < childRollCallList.length && checkbox.checked && !checkbox.disabled) {
    const child = childRollCallList[childRollCallIndex];
    fetch('/record_attendance', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: child.name, contact: child.contact })
    });
  }

  childRollCallIndex++;
  showChildRollCallName();
});
</script>

<!-- DOWNLOAD MODAL -->
<div class="modal fade" id="downloadModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content p-4">
      <h5 class="modal-title mb-3">Download Attendance Records</h5>
      <select id="dateDropdown" class="form-select mb-3"></select>
      <button class="btn w-100" id="downloadCsvBtn">Download CSV</button>
    </div>
  </div>
</div>

<div class="text-center mt-4">
  <button class="btn" data-bs-toggle="modal" data-bs-target="#downloadModal">ðŸ“¥ Download Attendance</button>
</div>


<footer class="text-center py-4">
  <p>&copy; 2025 AGT Records Management | Contact: xyd@gmail.com</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
<script>
  AOS.init({ duration: 800, once: true });

  document.querySelectorAll('nav .nav-link').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      const target = document.querySelector(link.getAttribute('href'));
      const offset = document.querySelector('nav').offsetHeight + 10;
      window.scrollTo({ top: target.offsetTop - offset, behavior: 'smooth' });
    });
  });

  const fillUpdateModal = (record) => {
    document.getElementById('update_first_name').value = record.first_name;
    document.getElementById('update_last_name').value = record.last_name;
    document.getElementById('update_age').value = record.age;
    document.getElementById('update_gender').value = record.gender;
    document.getElementById('update_birthday').value = record.birthday;
    document.getElementById('update_contact').value = record.contact_number;
    document.getElementById('update_age_group').value = record.age_group;
    document.getElementById('update_consent').value = record.consent;
    document.getElementById('update_id').value = record.id || '';
  };

  document.getElementById('searchInput').addEventListener('input', function () {
    const keyword = this.value;
    if (keyword.length < 2) return;

    fetch('/childrens_church/search', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: new URLSearchParams({ keyword })
    })
    .then(res => res.json())
    .then(data => {
      const output = document.getElementById('searchResults');
      const detail = document.getElementById('recordDetails');
      output.innerHTML = '';
      detail.classList.add('d-none');

      data.forEach(record => {
        const div = document.createElement('div');
        div.className = 'search-result-item';
        div.innerText = `${record.first_name} ${record.last_name}`;
        div.onclick = function () {
          output.innerHTML = '';
          detail.innerHTML = `
            <div class="glass-card">
              <h5>${record.first_name} ${record.last_name}</h5>
              <p>Age: ${record.age}</p>
              <p>Gender: ${record.gender}</p>
              <p>Birthday: ${record.birthday}</p>
              <p>Contact: ${record.contact_number}</p>
              <p>Age Group: ${record.age_group}</p>
              <p>Consent: ${record.consent}</p>
              <button class="btn mt-3" id="openUpdateBtn">Get Details</button>
            </div>
          `;
          detail.classList.remove('d-none');

          document.getElementById('openUpdateBtn').addEventListener('click', () => {
            fillUpdateModal(record);
            const modal = new bootstrap.Modal(document.getElementById('updateModal'));
            modal.show();
          });
        };
        output.appendChild(div);
      });
    });
  });
</script>
<script>
    // Optionally close nav when clicking a link
    document.querySelectorAll('.nav-links a').forEach(link => {
      link.addEventListener('click', () => {
        document.querySelector('.nav-links').classList.remove('open');
      });
    });
  </script>
    <script>
const attendanceSearchInput = document.getElementById('attendanceSearchInput');
const searchResults = document.getElementById('attendanceSearchResults');
const selectedCard = document.getElementById('selectedRecord');
let selectedChild = null;

attendanceSearchInput.addEventListener('input', function () {
  const keyword = this.value;
  if (keyword.length < 2) return;

  fetch('/childrens_church/search', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: new URLSearchParams({ keyword })
  })
  .then(res => res.json())
  .then(data => {
    searchResults.innerHTML = '';
    selectedCard.classList.add('d-none');

    data.forEach(record => {
      const div = document.createElement('div');
      div.className = 'search-result-item';
      div.innerText = `${record.first_name} ${record.last_name}`;
      div.onclick = function () {
        selectedChild = record;
        document.getElementById('selectedName').innerText = `${record.first_name} ${record.last_name}`;
        document.getElementById('selectedContact').innerText = `Contact: ${record.contact_number}`;
        selectedCard.classList.remove('d-none');
      };
      searchResults.appendChild(div);
    });
  });
});

document.getElementById('submitAttendance').addEventListener('click', function () {
  if (!selectedChild || !document.getElementById('markPresent').checked) {
    alert("Please select a child and check the attendance box.");
    return;
  }

  fetch('/record_attendance', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      name: `${selectedChild.first_name} ${selectedChild.last_name}`,
      contact: selectedChild.contact_number
    })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message || "Attendance recorded.");
    selectedCard.classList.add('d-none');
    document.getElementById('markPresent').checked = false;
    attendanceSearchInput.value = '';
    searchResults.innerHTML = '';
  });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  fetch('/get_attendance_dates')
    .then(res => res.json())
    .then(data => {
      const dropdown = document.getElementById('dateDropdown');
      data.forEach(date => {
        const option = document.createElement('option');
        option.value = date;
        option.textContent = date;
        dropdown.appendChild(option);
      });
    });

  document.getElementById('downloadCsvBtn').addEventListener('click', () => {
    const date = document.getElementById('dateDropdown').value;
    if (!date) return;

    fetch(`/download_attendance_csv?date=${date}`)
      .then(res => res.blob())
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `AGT_Attendance_${date}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      });
  });
});
</script>
</body>
</html>
